<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ç®±æœåŠ¡ç®¡ç†é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab:hover {
            background: #7c8fef;
            color: white;
        }

        .panel {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            min-height: 500px;
        }

        .panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 80px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 8px 20px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
            padding: 8px 20px;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-success:hover {
            background: #229954;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        /* è®¾ç½®åˆ—å®½ */
        .domains-table th:nth-child(1),
        .domains-table td:nth-child(1) { width: 25%; }
        .domains-table th:nth-child(2),
        .domains-table td:nth-child(2) { width: 30%; }
        .domains-table th:nth-child(3),
        .domains-table td:nth-child(3) { width: 20%; }
        .domains-table th:nth-child(4),
        .domains-table td:nth-child(4) { width: 25%; }

        .mails-table th:nth-child(1),
        .mails-table td:nth-child(1) { width: 25%; }
        .mails-table th:nth-child(2),
        .mails-table td:nth-child(2) { width: 25%; }
        .mails-table th:nth-child(3),
        .mails-table td:nth-child(3) { width: 25%; }
        .mails-table th:nth-child(4),
        .mails-table td:nth-child(4) { width: 15%; }
        .mails-table th:nth-child(5),
        .mails-table td:nth-child(5) { width: 10%; text-align: center; }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .loading {
            text-align: center;
            padding: 60px 40px;
            color: #666;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-sending {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0c5460;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            color: #333;
            font-size: 32px;
            font-weight: bold;
        }

        .domain-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .domain-info p {
            margin: 5px 0;
            color: #666;
        }

        .domain-info strong {
            color: #333;
        }

        .copy-btn {
            padding: 4px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        /* é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .modal-body {
            padding: 30px;
        }

        .mail-detail {
            line-height: 1.8;
        }

        .mail-detail .field {
            margin-bottom: 20px;
        }

        .mail-detail .label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .mail-detail .value {
            color: #333;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            word-break: break-all;
        }

        .mail-detail .body {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .no-data {
            text-align: center;
            padding: 60px 40px;
            color: #999;
            font-size: 16px;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“§ é‚®ç®±æœåŠ¡ç®¡ç†é¢æ¿</h1>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('dns')">DNSç®¡ç†</button>
                    <button class="tab" onclick="showTab('mails')">é‚®ä»¶åˆ—è¡¨</button>
                    <button class="tab" onclick="showTab('stats')">ç»Ÿè®¡ä¿¡æ¯</button>
                </div>
                <button class="btn btn-danger" onclick="logout()" style="padding: 8px 20px; font-size: 14px;">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- DNSç®¡ç†é¢æ¿ -->
        <div id="dns-panel" class="panel active">
            <h2>é‚®ç®±åŸŸåç®¡ç†</h2>
            <div id="dns-alert"></div>
            
            <div class="form-group">
                <label>æ³¨å†Œé‚®ç®±</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="email-prefix" placeholder="è¾“å…¥é‚®ç®±å‰ç¼€ï¼Œä¾‹å¦‚: hello" style="flex: 1;">
                    <span style="font-size: 16px; color: #666;">@niuma946.com</span>
                    <button class="btn btn-primary" onclick="createMailDomain()">æ³¨å†Œé‚®ç®±</button>
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">è¾“å…¥é‚®ç®±å‰ç¼€åå°†è‡ªåŠ¨æ³¨å†Œä¸º xxxx@niuma946.com æ ¼å¼</small>
            </div>

            <h3 style="margin-top: 30px;">å·²åˆ›å»ºçš„é‚®ç®±åŸŸå</h3>
            <div id="domains-loading" class="loading">åŠ è½½ä¸­...</div>
            <table id="domains-table" class="domains-table" style="display: none;">
                <thead>
                    <tr>
                        <th>é‚®ç®±åœ°å€</th>
                        <th>åŸŸå</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="domains-tbody"></tbody>
            </table>
        </div>

        <!-- é‚®ä»¶åˆ—è¡¨é¢æ¿ -->
        <div id="mails-panel" class="panel">
            <h2>æ”¶åˆ°çš„é‚®ä»¶</h2>
            <div id="mails-loading" class="loading">åŠ è½½ä¸­...</div>
            <table id="mails-table" class="mails-table" style="display: none;">
                <thead>
                    <tr>
                        <th>å‘ä»¶äºº</th>
                        <th>æ”¶ä»¶äºº</th>
                        <th>ä¸»é¢˜</th>
                        <th>æ¥æ”¶æ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="mails-tbody"></tbody>
            </table>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯é¢æ¿ -->
        <div id="stats-panel" class="panel">
            <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3>é‚®ä»¶æ€»æ•°</h3>
                    <div class="number" id="total-mails">-</div>
                </div>
                <div class="stat-card">
                    <h3>é‚®ç®±åŸŸåæ•°</h3>
                    <div class="number" id="total-domains">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="mail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“§ é‚®ä»¶è¯¦æƒ…</h2>
                <button class="close" onclick="closeMailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mail-detail-content" class="mail-detail">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å†™é‚®ä»¶æ¨¡æ€æ¡† -->
    <div id="compose-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœ‰ï¸ æ’°å†™é‚®ä»¶</h2>
                <button class="close" onclick="closeComposeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="compose-alert"></div>
                <form id="compose-form">
                    <div class="form-group">
                        <label for="compose-from">å‘ä»¶äºº</label>
                        <input type="email" id="compose-from" readonly style="background: #f8f9fa; color: #666;">
                        <small style="color: #666;">ä½¿ç”¨å·²åˆ›å»ºçš„é‚®ç®±ä½œä¸ºå‘ä»¶äºº</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="compose-to">æ”¶ä»¶äºº</label>
                        <input type="email" id="compose-to" placeholder="è¾“å…¥æ”¶ä»¶äººé‚®ç®±åœ°å€" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="compose-subject">ä¸»é¢˜</label>
                        <input type="text" id="compose-subject" placeholder="è¾“å…¥é‚®ä»¶ä¸»é¢˜" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="compose-body">é‚®ä»¶å†…å®¹</label>
                        <textarea id="compose-body" rows="10" placeholder="è¾“å…¥é‚®ä»¶å†…å®¹..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;" required></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeComposeModal()" style="background: #6c757d; color: white;">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">å‘é€é‚®ä»¶</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('token');
            const expiry = localStorage.getItem('tokenExpiry');
            
            if (!token || !expiry || Date.now() >= expiry * 1000) {
                localStorage.removeItem('token');
                localStorage.removeItem('tokenExpiry');
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }

        // è·å–è¯·æ±‚å¤´ï¼ˆå¸¦tokenï¼‰
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // å¤„ç†401æœªæˆæƒé”™è¯¯
        function handleUnauthorized() {
            localStorage.removeItem('token');
            localStorage.removeItem('tokenExpiry');
            window.location.href = '/login.html';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯
        if (!checkAuth()) {
            throw new Error('Not authenticated');
        }

        // æ ‡ç­¾åˆ‡æ¢
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + '-panel').classList.add('active');
            
            if (tab === 'dns') loadDomains();
            if (tab === 'mails') loadMails();
            if (tab === 'stats') loadStats();
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('dns-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alert.innerHTML = '', 5000);
        }

        // é‚®ä»¶å‘é€ä¸“ç”¨æç¤ºå‡½æ•°
        function showComposeAlert(message, type = 'success') {
            const alert = document.getElementById('compose-alert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            // æˆåŠŸæç¤º3ç§’åè‡ªåŠ¨å…³é—­ï¼Œé”™è¯¯æç¤º5ç§’åå…³é—­
            const timeout = type === 'success' ? 3000 : 5000;
            setTimeout(() => alert.innerHTML = '', timeout);
        }

        // æ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€
        function showComposeSending() {
            const alert = document.getElementById('compose-alert');
            alert.innerHTML = `
                <div class="alert alert-sending">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="loading-spinner"></div>
                        <span>æ­£åœ¨å‘é€é‚®ä»¶ï¼Œè¯·ç¨å€™...</span>
                    </div>
                </div>
            `;
        }

        // åˆ›å»ºé‚®ç®±åŸŸå
        async function createMailDomain() {
            const prefix = document.getElementById('email-prefix').value.trim();
            if (!prefix) {
                showAlert('è¯·è¾“å…¥é‚®ç®±å‰ç¼€', 'error');
                return;
            }

            // éªŒè¯å‰ç¼€æ ¼å¼ï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€.ã€-ã€_ï¼‰
            if (!/^[a-zA-Z0-9._-]+$/.test(prefix)) {
                showAlert('é‚®ç®±å‰ç¼€åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€.ã€-ã€_', 'error');
                return;
            }

            const email = prefix + '@niuma946.com';

            try {
                const response = await fetch(`${API_BASE}/domains`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ email })
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'åˆ›å»ºå¤±è´¥');
                }

                const data = await response.json();
                showAlert(`é‚®ç®±æ³¨å†ŒæˆåŠŸï¼é‚®ç®±åœ°å€: ${email}`);
                document.getElementById('email-prefix').value = '';
                loadDomains();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // åŠ è½½åŸŸååˆ—è¡¨
        async function loadDomains() {
            try {
                const response = await fetch(`${API_BASE}/domains`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                const data = await response.json();
                
                document.getElementById('domains-loading').style.display = 'none';
                document.getElementById('domains-table').style.display = 'table';
                
                const tbody = document.getElementById('domains-tbody');
                
                if (!data.domains || data.domains.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="no-data">æš‚æ— é‚®ç®±ï¼Œè¯·æ³¨å†Œä¸€ä¸ªé‚®ç®±</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.domains.map(d => `
                    <tr>
                        <td>${d.email}</td>
                        <td>
                            <strong>${d.full_domain}</strong>
                            <button class="copy-btn" onclick="copyText('${d.full_domain}')">å¤åˆ¶</button>
                        </td>
                        <td>${new Date(d.created_at).toLocaleString('zh-CN')}</td>
                        <td>
                            <button class="btn btn-success" onclick="openComposeModal('${d.email}')">å‘é€é‚®ä»¶</button>
                            <button class="btn btn-danger" onclick="deleteDomain(${d.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½åŸŸååˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('domains-tbody').innerHTML = 
                    '<tr><td colspan="4" class="no-data">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</td></tr>';
            }
        }

        // åˆ é™¤åŸŸå
        async function deleteDomain(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé‚®ç®±åŸŸåå—?')) return;

            try {
                const response = await fetch(`${API_BASE}/domains/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');

                showAlert('åŸŸååˆ é™¤æˆåŠŸ');
                loadDomains();
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // åŠ è½½é‚®ä»¶åˆ—è¡¨
        async function loadMails() {
            try {
                const response = await fetch(`${API_BASE}/mails?limit=50`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                const data = await response.json();
                
                document.getElementById('mails-loading').style.display = 'none';
                document.getElementById('mails-table').style.display = 'table';
                
                const tbody = document.getElementById('mails-tbody');
                
                if (!data.mails || data.mails.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">æš‚æ— é‚®ä»¶</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.mails.map(m => `
                    <tr>
                        <td>${m.from}</td>
                        <td>${m.to}</td>
                        <td>${m.subject || '(æ— ä¸»é¢˜)'}</td>
                        <td>${new Date(m.received_at).toLocaleString('zh-CN')}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewMail(${m.id})">æŸ¥çœ‹</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½é‚®ä»¶åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('mails-tbody').innerHTML = 
                    '<tr><td colspan="5" class="no-data">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</td></tr>';
            }
        }

        // æŸ¥çœ‹é‚®ä»¶è¯¦æƒ…
        async function viewMail(id) {
            const modal = document.getElementById('mail-modal');
            const content = document.getElementById('mail-detail-content');
            
            modal.classList.add('active');
            content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/mails/${id}`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const mail = await response.json();
                
                content.innerHTML = `
                    <div class="field">
                        <div class="label">å‘ä»¶äºº</div>
                        <div class="value">${mail.from}</div>
                    </div>
                    <div class="field">
                        <div class="label">æ”¶ä»¶äºº</div>
                        <div class="value">${mail.to}</div>
                    </div>
                    <div class="field">
                        <div class="label">ä¸»é¢˜</div>
                        <div class="value">${mail.subject || '(æ— ä¸»é¢˜)'}</div>
                    </div>
                    <div class="field">
                        <div class="label">æ¥æ”¶æ—¶é—´</div>
                        <div class="value">${new Date(mail.received_at).toLocaleString('zh-CN')}</div>
                    </div>
                    <div class="field">
                        <div class="label">é‚®ä»¶å†…å®¹</div>
                        <div class="value body">${mail.body || '(ç©º)'}</div>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // å…³é—­é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡†
        function closeMailModal() {
            document.getElementById('mail-modal').classList.remove('active');
        }

        // æ‰“å¼€å†™é‚®ä»¶æ¨¡æ€æ¡†
        function openComposeModal(fromEmail) {
            const modal = document.getElementById('compose-modal');
            document.getElementById('compose-from').value = fromEmail;
            document.getElementById('compose-to').value = '';
            document.getElementById('compose-subject').value = '';
            document.getElementById('compose-body').value = '';
            modal.classList.add('active');
        }

        // å…³é—­å†™é‚®ä»¶æ¨¡æ€æ¡†
        function closeComposeModal() {
            document.getElementById('compose-modal').classList.remove('active');
            // æ¸…ç©ºæç¤ºä¿¡æ¯
            document.getElementById('compose-alert').innerHTML = '';
        }

        // å‘é€é‚®ä»¶
        async function sendEmail() {
            const from = document.getElementById('compose-from').value;
            const to = document.getElementById('compose-to').value;
            const subject = document.getElementById('compose-subject').value;
            const body = document.getElementById('compose-body').value;

            if (!to || !subject || !body) {
                showComposeAlert('è¯·å¡«å†™å®Œæ•´çš„é‚®ä»¶ä¿¡æ¯', 'error');
                return;
            }

            if (!validateEmail(to)) {
                showComposeAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ”¶ä»¶äººé‚®ç®±åœ°å€', 'error');
                return;
            }

            // æ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€
            showComposeSending();

            try {
                const response = await fetch(`${API_BASE}/send-email`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        from: from,
                        to: to,
                        subject: subject,
                        body: body
                    })
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'å‘é€å¤±è´¥');
                }

                // å‘é€æˆåŠŸ
                showComposeAlert('âœ… é‚®ä»¶å‘é€æˆåŠŸï¼é‚®ä»¶å·²æˆåŠŸå‘é€åˆ° ' + to);
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('compose-to').value = '';
                document.getElementById('compose-subject').value = '';
                document.getElementById('compose-body').value = '';
                
                // 2ç§’åå…³é—­æ¨¡æ€æ¡†
                setTimeout(() => {
                    closeComposeModal();
                }, 2000);
                
            } catch (error) {
                console.error('é‚®ä»¶å‘é€å¤±è´¥:', error);
                showComposeAlert('âŒ å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // éªŒè¯é‚®ç®±æ ¼å¼
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const mailModal = document.getElementById('mail-modal');
            const composeModal = document.getElementById('compose-modal');
            
            if (event.target === mailModal) {
                closeMailModal();
            }
            if (event.target === composeModal) {
                closeComposeModal();
            }
        }

        // å†™é‚®ä»¶è¡¨å•æäº¤äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('compose-form').addEventListener('submit', function(e) {
                e.preventDefault();
                sendEmail();
            });
        });

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const headers = getAuthHeaders();
                const [mailsRes, domainsRes] = await Promise.all([
                    fetch(`${API_BASE}/stats`, { headers }),
                    fetch(`${API_BASE}/domains`, { headers })
                ]);

                if (mailsRes.status === 401 || domainsRes.status === 401) {
                    handleUnauthorized();
                    return;
                }

                const mailsData = await mailsRes.json();
                const domainsData = await domainsRes.json();

                document.getElementById('total-mails').textContent = mailsData.total_mails || 0;
                document.getElementById('total-domains').textContent = domainsData.domains.length || 0;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // å¤åˆ¶æ–‡æœ¬
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('token');
                localStorage.removeItem('tokenExpiry');
                window.location.href = '/login.html';
            }
        }

        // åˆå§‹åŒ–
        loadDomains();
    </script>
</body>
</html>
